$(document).ready(function () {

    updateSubcategories(true);
    if ($('#expansion').val() !== '0') {
        updateAreas(true);
    }

    $(document).on('click', '#close-feedback', function () {
        $('div.feedback-container').hide();
    });

    $(document).on('click', '#start-edit', function (e) {
        e.preventDefault();

        $('input, textarea').each(function () {
            $(this).removeAttr('readonly');
        });

        $('select, button, span.btn.btn-warning').each(function () {
            $(this).removeAttr('disabled');
        });
    });

    $(document).on('click', '#update-button', function () {
        $('input, textarea').each(function () {
            $(this).removeAttr('readonly');
        });

        $('select, button').each(function () {
            $(this).removeAttr('disabled');
        });
    });

    $(document).on('click', '#start-edit-admin', function (e) {
        e.preventDefault();

        $('select#status, button').each(function () {
            $(this).removeAttr('disabled');
        });
    });

    $(document).on('click', 'span.up, span.down', function () {
        var url = $('span.i_have_url_for_vote').html();
        var el = $(this);
        var value = 0;

        if (el.hasClass('up')) {
            value = 1;
        } else {
            value = -1;
        }

        var reportId = el.parent().siblings('a').children('div.id').attr('data-action');

        $.ajax({
            method: 'GET',
            url: url,
            data: {
                userVote: value,
                reportId: reportId
            },
            success: function (data) {
                var dataObject = JSON.parse(data);
                if (dataObject.status === 'success') {
                    var ratingHtml = '<strong>' + dataObject.rating + '</strong>';
                    el.siblings('span.rating-points').html(ratingHtml);
                    var parent = el.parent();
                    var toHide = getOppositeVote(dataObject.userVote);
                    var selector = 'span.' + dataObject.userVote;
                    var spanSelector = el.hasClass('up') ? '.up' : '.down';
                    var ratingSelector = '.' + dataObject.userVote;
                    var toShow = '';
                    if (dataObject.userVote === 0) {
                        ratingSelector = '.none';
                        toShow = 'span' + ratingSelector + spanSelector;
                        el.hide();
                        parent.children(toShow).show();
                        return;
                    }
                    parent.children(toHide.hide).hide();
                    parent.children(toHide.class).hide();
                    parent.children(toHide.toShow).show();
                    parent.children(selector).show();
                }
            }
        });

    });

    $(document).on('click', 'img.edit-comment', function () {
        var el = $(this);
        el.siblings('textarea.comment-editable').removeAttr('readonly');
        el.hide();
    });

    $(document).on('click', 'img.save-comment', function () {
        var el = $(this);
        el.siblings('textarea.comment-editable').attr('readonly', 'readonly');
        // el.siblings('img.edit-comment').show();
        el.hide();

        $.ajax({
            method: 'post',
            url: $('span.commentUpdateUrl').html(),
            data: {
                comment: el.siblings('textarea.comment-editable').val(),
                id: el.siblings('span.comment-id').html()
            },
            success: function (data) {
                var dataObject = JSON.parse(data);
                if (dataObject.status === 'success') {
                    el.siblings('img.success-comment').show();
                    el.siblings('span.comment-timestamp').html(dataObject.data);
                    setTimeout(function () {
                        el.siblings('img.success-comment').hide();
                        el.siblings('img.edit-comment').show();
                    }, 1500);
                } else {
                    el.siblings('img.edit-comment').show();
                }
            }
        });
    });

    $(document).on('keydown', 'textarea.comment-editable', function () {
        if ($(this).is("[readonly]")) {
            return;
        }
        var el = $(this);
        el.siblings('img.save-comment').show();
    });


    var getOppositeVote = function (vote) {

        var oppositeInt = vote * -1;
        if (oppositeInt === 1) {
            return {
                hide: 'span.1.up',
                class: 'span.down.none',
                toShow: 'span.up.none'
            }
        }

        return {
            hide: 'span.-1.down',
            class: 'span.up.none',
            toShow: 'span.down.none'
        }
    };

    setTimeout(function () {
        $('.feedback-container').hide();
    }, 3000);

    $(document).on('click', 'span.first, span.previous, span.next, span.last', function () {
        var el = $(this);
        var page = el.attr('data-action');
        var currentPage = $('span.current-page').html();
        if (page === currentPage) {
            return;
        }

        var filterValues = getFilterValues();
        $.ajax({
            method: 'POST',
            url: $('span.i_have_url_for_paging').html(),
            data: {
                filter: filterValues,
                page: page
            },
            success: function (data) {
                var contentHolder = $('div.pagination-content');
                contentHolder.fadeOut();
                contentHolder.html(data);
                contentHolder.fadeIn();
            }
        });
    });

    $(document).on('click', '#add-link, #add-img', function () {
        var el = $(this);
        var lastSiblingInputValue = el.siblings('input:last').val();
        if (lastSiblingInputValue.length <= 0 || el.is(':disabled') || el.siblings('input:last').hasClass('not-legit')) {
            return;
        }

        var valueLength = 0;
        el.siblings('input').each(function (index, input) {
            valueLength += $(input).val().length;
        });

        if (valueLength >= 240) {
            alert('Limit reached, you are not allowed to add more.. sorry');
            return;
        }

        var toAppend = '<input class="form-control image-upload" type="text" name="img[]" placeholder="https://i.imgur.com/Dokbyyd.jpg" style="margin-top:5px;">' +
            '<span class="not-legit-explanation" style="display: none">Make sure its imgur link and ends with valid image extension (jpg,jpeg,png)</span>';
        if (el.attr('id') === 'add-link') {
            toAppend = '<input class="form-control" type="text" name="link[]" style="margin-top:5px;">';
        }

        $(toAppend).insertAfter(el.siblings('input:last'));
    });

    $(document).on('mouseover', 'img.details-image', function () {
        var el = $(this);
        el.fadeTo('slow', '0.2');
        // el.css('opacity', '0.2');
        // el.siblings('img.preview-image').fadeIn();
        // el.siblings('img.preview-image').css('display', 'block');
    });

    $(document).on('mouseout', 'img.details-image', function () {
        var el = $(this);
        // el.fadeOut();
        // el.css('opacity', '1');
        el.fadeTo('slow', '1');
    });

    // $('img.preview-image').each(function (index, element) {
    //     var jqElement = $(element);
    //     var image = jqElement.siblings('img.details-image');
    //     jqElement.height(image.height());
    //     jqElement.width(image.width());
    // });

    $(document).on('click', 'div.preview-background, span.close', function () {
        $('div.preview-modal').fadeOut();
    });

    $(document).on('click', 'img.details-image', function () {
        var el = $(this);
        // el.fadeOut();
        // var siblingImage = el.siblings('img.details-image');
        // siblingImage.css('opacity', '1');
        var srcToShow = el.attr('src');
        $('img.full-size-image').attr('src', srcToShow);
        $('div.preview-modal').fadeIn();
    });

    $(document).on('change', 'input.image-upload', function () {
        var el = $(this);
        if (el.val().length === 0) {
            el.siblings('span.not-legit-explanation:last').fadeOut();
            el.removeClass('not-legit');
            return;
        }
        var value = el.val();
        var substring = 'https://i.imgur.com/';
        var substringTwo = 'http://i.imgur.com/';
        var jpg = '.jpg';
        var png = '.png';
        var jpeg = '.jpeg';
        if (!value.includes(substring) && !value.includes(substringTwo)) {
            el.addClass('not-legit');
            el.siblings('span.not-legit-explanation:last').fadeIn();
            return;
        }

        if (!value.includes(jpg) && !value.includes(png) && !value.includes(jpeg)) {
            el.siblings('span.not-legit-explanation:last').fadeIn();
            el.addClass('not-legit');
            return;
        }

        var valueAsArray = value.split('.');
        value = valueAsArray[valueAsArray.length - 1];
        if (value !== 'jpg' && value !== 'png' && value !== 'jpeg') {
            el.siblings('span.not-legit-explanation:last').fadeIn();
            el.addClass('not-legit');
            return;
        }

        el.siblings('span.not-legit-explanation:last').fadeOut();
        el.removeClass('not-legit');
    });

    $(document).on('click', '.save-btn', function (e) {
        $('input.not-legit').each(function (index, element) {
            $(element).fadeOut();
            $(element).fadeIn();
            e.preventDefault();
        })
    });

    var previousValues = {};
    $(document).on('click', 'button.apply-filter, button.reset, button.owned, button.search, div.order span', function (e) {
        var el = $(this);
        var filterValues = getFilterValues();
        var shouldSend = true;
        if (JSON.stringify(filterValues) === JSON.stringify(previousValues)) {
            shouldSend = false;
        }
        previousValues = filterValues;
        if (filterValues.category === '' && filterValues.realm === '' && filterValues.status === '' && filterValues.search === '' && filterValues.priority === '') {
            shouldSend = false;
        }

        if (el.hasClass('reset')) {
            previousValues = {};
            $('button.owned').removeClass('active');
            fireFilterAjaxAndHandleResponse('reset');
            return;
        }

        if (el.hasClass('owned')) {
            filterValues.me = true;
            $(this).addClass('active');
            fireFilterAjaxAndHandleResponse(filterValues);
            return;
        }

        if (el.parent().hasClass('order')) {
            if (el.parent().attr('data-action') === 'created') {
                filterValues.created = el.hasClass('glyphicon-arrow-up') ? 'desc' : 'asc';
            } else {
                filterValues.rating = el.hasClass('glyphicon-arrow-up') ? 'desc' : 'asc';
            }
            fireFilterAjaxAndHandleResponse(filterValues);

            return;
        }

        if (shouldSend) {
            fireFilterAjaxAndHandleResponse(filterValues);
        }
    });

    $(document).on('click', 'button.reset', function (e) {
        $('select').each(function (index, elem) {
            var element = $(elem);
            element.val($("element option:first").val());
            element.change();
        });
    });

    var fireFilterAjaxAndHandleResponse = function (valuesObject) {
        if (valuesObject === 'reset') {
            valuesObject = {
                reset: true
            }
        }
        var url = $('span.i_have_url_for_paging').html();
        if (location.protocol !== 'https:') {
            url = $('span.i_have_url_for_paging_non_ssl').html();
        }
        $.ajax({
            method: 'POST',
            url: url,
            data: {
                filter: valuesObject,
                page: 0
            },
            success: function (data) {
                var contentHolder = $('div.pagination-content');
                contentHolder.fadeOut();
                contentHolder.html(data);
                contentHolder.fadeIn();
            }
        });
    };

    var getFilterValues = function () {
        var toReturn = {};
        toReturn.realm = $('select#filter-realm').val();
        toReturn.category = $('select#filter-category').val();
        toReturn.status = $('select#filter-status').val();
        toReturn.search = $('input#filter-search').val();
        toReturn.priority = $('select#filter-priority').val();

        return toReturn;
    };

    $(document).on('change', '#category', function (e) {
        updateSubcategories();
    });

    function updateSubcategories(load) {
        if (typeof load === 'undefined') {
            load = false;
        }
        var categoriesSelect = $('#category');
        var el = $('#subcategory');
        var selectedCategoryOption = categoriesSelect.find(":selected");
        var categoryId = selectedCategoryOption.attr('data-category');
        var shouldSelectFirst = true;
        var visibleElementsCount = 0;
        $.each(el.children(), function (index, element) {
            element = $(element);
            if (element.attr('data-category') !== categoryId) {
                element.hide();
            } else {
                if (shouldSelectFirst && !load) {
                    shouldSelectFirst = false;
                    el.val(element.val());
                }
                element.show();
                visibleElementsCount++;
            }
        });
        if (!load) {
            hideOrShowSelectBlock(el, visibleElementsCount);
        }
    }

    function hideOrShowSelectBlock(el, count) {
        if (count === 0) {
            el.parent().fadeOut();
            el.attr('disabled', 'disabled');
        } else {
            el.parent().fadeIn();
            el.removeAttr('disabled');
        }
    }

    $(document).on('change', '#expansion', function (e) {
        var el = $(this);
        if (el.val() === '0') {
            var area = $('#area');
            area.attr('disabled', 'disabled');
            area.parent().fadeOut();
            var zone = $('#zone');
            zone.attr('disabled', 'disabled');
            zone.parent().fadeOut();
            return;
        }
        updateAreas();
    });

    function updateAreas(load) {
        if (typeof load === 'undefined') {
            load = false;
        }
        var expansionSelect = $('#expansion');
        var el = $('#area');
        var selectedExpansion = expansionSelect.find(":selected");
        var expansionId = selectedExpansion.attr('data-expansion');
        var shouldSelect = true;
        $.each(el.children(), function (index, element) {
            element = $(element);
            if (element.attr('data-expansion') !== expansionId) {
                element.hide();
            } else {
                if (shouldSelect && !load) {
                    shouldSelect = false;
                    el.val(element.val());
                }
                element.show();
            }
        });
        if (!load) {
            hideOrShowSelectBlock(el, 1);
        }
        updateZones(load);
    }

    $(document).on('change', '#area', function (e) {
        updateZones();
    });

    function updateZones(load) {
        if (typeof load === 'undefined') {
            load = false;
        }
        var expansionSelect = $('#area');
        var el = $('#zone');
        var selectedExpansion = expansionSelect.find(":selected");
        var expansionId = selectedExpansion.val();
        var shouldSelect = true;
        $.each(el.children(), function (index, element) {
            element = $(element);
            if (element.attr('data-area') !== expansionId) {
                element.hide();
            } else {
                if (shouldSelect && !load) {
                    shouldSelect = false;
                    el.val(element.val());
                }
                element.show();
            }
        });
        if (!load) {
            hideOrShowSelectBlock(el, 1);
        }
    }
});

function loadImagesPreview() {
}
$(document).ready(function () {
    var refreshFeed = false;
    var self = 0;
    var $container = $('div.feed_container');

    $(document).on('click', 'div.feed_collapsed', function (e) {
        refreshFeed = !refreshFeed;
        $('div.feed_container').fadeIn();
        $('div.div.feed_collapsed').fadeOut();
    });

    $(document).on('click', 'span.feed_close', function (e) {
        refreshFeed = !refreshFeed;
        $('div.feed_container').fadeOut();
        $('div.div.feed_collapsed').fadeIn();
    });


    $(document).on('click', 'div.load_more', function (e) {
        if ($(this).attr('data-role') === '0') {
            alert("Sorry, still unable to find anything!");
            return;
        }
        getFeed();
    });

    $(document).on('click', 'button.feed-subscribe', function (e) {
        var $el = $(this);
        var id = $el.attr('data-action');
        let url = $('span.i_have_url_for_subscription').html();
        $.ajax({
            method: 'GET',
            url: url + '/' + id,
            success: function (data) {
                changeButtonText($el);
            }
        });
    });

    function changeButtonText($button) {
        var text = $button.text().trim();
        if (text === 'Subscribe') {
            $button.html('Unsubscribe');
        } else {
            $button.html('Subscribe')
        }
    }

    function getFeed() {
        let $loadMoreButton = $container.find('div.load_more');
        let $nextPage;
        if ($loadMoreButton.length === 0) {
            $nextPage = 0;
        } else {
            $nextPage = parseInt($loadMoreButton.attr('data-action'));
        }
        let url = $('span.i_have_url_for_feed').html();
        $.ajax({
            method: 'GET',
            url: url + '/' + $nextPage + '/' + self,
            success: function (data) {
                updateFeed(JSON.parse(data));
            }
        });
    }

    function updateFeed(data) {
        let $loadMoreButton = $container.find('div.load_more');
        if ($loadMoreButton.length === 0) {
            if (data.length === 0) {
                $loadMoreButton = $("<div class='load_more btn' data-action='0' data-role='0'>There is no news yet!</div>");
            } else {
                $loadMoreButton = $("<div class='load_more btn' data-action='0' data-role='1'>Load more!</div>");
            }
        }
        $loadMoreButton.remove();
        $.each(data, function (i, element) {
            drawFeedEntity(element);
        });
        $loadMoreButton.attr('data-action', parseInt($loadMoreButton.attr('data-action')) + 1);
        $container.append($loadMoreButton);
    }

    function drawFeedEntity(element) {
        $container.append(element);
        $container.append("<hr>");
    }

    setInterval(function () {
        if (!refreshFeed) {
            return;
        }
        getNewFeed();
    }, 10000);

    function getNewFeed() {
        var lastId = getLatestId();
        let url = $('span.i_have_url_for_new_feed').html();
        $.ajax({
            method: 'GET',
            url: url + '/' + lastId + '/' + self,
            success: function (data) {
                prependFeed(JSON.parse(data));
            }
        });
    }

    function getLatestId() {
        return $container.find('div.feed-container').first().attr('data-advicevalue');
    }

    function prependFeed(data) {
        var $firstElement = $('span.feed_close');
        if ($firstElement.length === 0) {
            $firstElement = $container.find('br');
        }
        $.each(data, function (i, element) {
            $("<hr>").insertAfter($firstElement);
            $(element).insertAfter($firstElement);
        });
    }


    var $ucpFeedContainer = $('#feed');
    var $ucpSubscriptionsContainer = $('#subscriptions');

    if ($ucpFeedContainer.length !== 0 && $ucpSubscriptionsContainer.length !== 0) {
        initUcpFeed();
    }

    if ($('div.feed_container').length !== 0) {
        $container = $('div.feed_container');
        refreshFeed = true;
        getFeed();
    }

    function initUcpFeed() {
        refreshFeed = true;
        $container = $('div.ucp-feed_container.feed-feed');
        getFeed();
    }

    $(document).on('click', '#feed, #subscriptions', function () {
        var $el = $(this);
        var $feed = $('div.ucp-feed');
        var $subscriptions = $('div.ucp-subscriptions');
        if ($el.attr('id') === 'feed') {
            self = 0;
            $container = $('div.ucp-feed_container.feed-feed');
            $('#feed').addClass('active');
            $('#subscriptions').removeClass('active');
            $feed.removeClass('hidden');
            $subscriptions.addClass('hidden');
        } else {
            self = 1;
            $container = $('div.ucp-feed_container.subscriptions-feed');
            $('#subscriptions').addClass('active');
            $('#feed').removeClass('active');
            $subscriptions.removeClass('hidden');
            $feed.addClass('hidden');
            if ($container.children().length < 2) {
                getFeed();
            }
        }

        refreshFeed = true;
    })
});
